# Промпт: План доработки скорости загрузки и UX (каталог, профиль, бонусы)

## Контекст проекта

Telegram Mini App (Flowers Studio Bot): каталог товаров (источник — Floria API), корзина, оформление заказа, профиль (телефон, бонусы, адреса, заказы), приветственный бонус 500 ₽, интеграция с Posiflora (клиенты и бонусы). Backend — Node.js (Express), frontend — React (Vite), авторизация по Telegram initData.

---

## Что есть сейчас (текущее состояние)

### Загрузка и отображение данных
- **Каталог товаров**: запрос к backend `GET /api/products` (backend дергает Floria API). При долгом ответе или таймауте пользователь видит экран «Не удалось загрузить товары» с текстом «Request timed out» и кнопкой «Обновить».
- **Профиль**: при загрузке вызывается `GET /api/users/me`; при ошибке или таймауте показывается красное сообщение «Не удалось загрузить профиль. Попробуйте позже.» Данные профиля (имя, ник Telegram, телефон, бонусы, категория, кэшбек) не кэшируются на клиенте с отображением времени актуальности.
- **Скорость**: нет агрессивного кэширования, нет показа «последних сохранённых данных» пока идёт фоновое обновление. Всё ждёт ответа API — при медленной сети или медленном Floria/backend всё «висит» и грузится долго.

### Бонусы и приветственный бонус
- В профиле есть блок «Контакт и бонусы»:
  - Поле «Телефон» (input) и кнопка «Сохранить».
  - Текст «Бонусы: X ₽», «Категория», «Кэшбек X%».
  - Текст «Получите 500 бонусов в подарок — введите телефон и нажмите кнопку ниже».
  - Кнопка «Получить 500 бонусов» (с иконкой подарка). По нажатию вызывается `POST /api/users/me/claim-welcome-bonus` с телом `{ phone }`; бэкенд проверяет, что бонус ещё не начислялся, начисляет 500 и синхронизирует с Posiflora.
- После получения бонуса кнопка должна скрываться (логика есть по `welcomeBonusClaimed` с бэкенда), но телефон сейчас отображается в отдельном блоке «Контакт и бонусы» в виде поля ввода, а не мелкой строчкой под ником Telegram с иконкой редактирования.
- Нет сценария «одна кнопка → поп-ап ввода телефона → отображение телефона под ником с карандашом → кнопка навсегда скрывается».

### Итог по текущему состоянию
- Каталог и профиль сильно зависят от скорости API; при таймаутах — только ошибка и «Обновить».
- Нет стратегии «сначала показать последние данные + плашка „данные актуальны на …“ + фоновое обновление».
- Бонусы: кнопка «Получить 500 бонусов» и блок телефона реализованы, но UX не соответствует требованиям (телефон под ником, поп-ап, одна кнопка, которая навсегда исчезает после использования).

---

## Что требуется сделать

### 1. Максимально быстрая загрузка всего в приложении (приоритет №1)
- **Каталог товаров** — самый важный экран. Нужно:
  - Сократить время до первого отображения: кэш на клиенте (localStorage/sessionStorage или in-memory) последнего успешного ответа списка товаров; при открытии каталога сразу показывать закэшированные данные (если есть), параллельно запрашивать свежие и подменять при получении.
  - Увеличить таймаут или сделать повторные запросы с экспоненциальной задержкой, чтобы реже показывать «Request timed out».
  - На бэкенде: по возможности кэшировать ответы Floria (Redis) с коротким TTL, чтобы повторные запросы каталога быстрее отвечали.
- **Профиль и остальные экраны**: та же идея — при открытии сразу показывать последние сохранённые данные (если есть), в фоне запрашивать актуальные и обновлять UI.
- Общая цель: пользователь почти не видит пустой экран или спиннер; сначала видит данные (пусть чуть устаревшие), затем они тихо обновляются.

### 2. Запоминание последних данных и фоновое обновление
- Хранить на клиенте (localStorage или state + persist):
  - последний успешный ответ каталога (список товаров, пагинация);
  - последний успешный ответ профиля (`/api/users/me`: бонусы, телефон, категория, `welcomeBonusClaimed` и т.д.).
- При открытии соответствующего экрана:
  - сразу рендерить из кэша (если есть);
  - отправить запрос за актуальными данными в фоне;
  - при получении ответа — обновить UI и кэш;
  - показывать внизу экрана плашку мелким серым шрифтом: **«Данные актуальны на DD.MM.YYYY, HH:MM»** (время последнего успешного обновления с сервера). Если данные только из кэша и запрос ещё не вернулся — можно писать «Обновление…» или показывать время кэша.
- Не блокировать интерфейс: не показывать полноэкранную ошибку, если есть кэш; при ошибке фонового запроса оставить старые данные и при желании показать мелкое «Не удалось обновить» с повторной попыткой.

### 3. Бонусы: одна кнопка, поп-ап телефона, отображение под ником, кнопка исчезает навсегда
- **Одна кнопка**: в профиле для пользователей, которые ещё не получили приветственный бонус (`welcomeBonusClaimed === false`), видна только одна кнопка — **«Получить 500 бонусов»** (без отдельного большого поля телефона в основном блоке).
- **При нажатии**: открывается **поп-ап (модальное окно)** с полем ввода номера телефона и кнопкой «Подтвердить» / «Получить». Валидация формата телефона на клиенте; при успехе — `POST /api/users/me/claim-welcome-bonus` с `{ phone }`, закрыть поп-ап, обновить профиль.
- **Отображение телефона**: после ввода (и сохранения на бэкенде) номер телефона должен отображаться **ниже ника в Telegram** (@username) **одной маленькой строчкой**. Рядом с номером — **маленькая иконка карандаша (чёрно-белая)** для редактирования; по нажатию — снова поп-ап или инлайн-редактирование телефона с сохранением через `PATCH /api/users/me` (или существующий эндпоинт обновления профиля).
- **Кнопка «Получить 500 бонусов»** после успешного нажатия (бонус получен) **больше никогда не отображается** у этого пользователя (бэкенд уже отдаёт `welcomeBonusClaimed: true` — нужно лишь не рендерить кнопку и убрать призыв к её нажатию).

---

## Приоритеты
1. **Каталог товаров** — скорость загрузки и устойчивость к таймаутам (кэш, показ последних данных, фоновое обновление).
2. **Скорость загрузки всего приложения** — та же стратегия для профиля и остальных экранов: кэш + фоновое обновление + плашка «Данные актуальны на …».
3. **Бонусы и телефон** — одна кнопка, поп-ап ввода телефона, телефон под ником с карандашом, скрытие кнопки навсегда после получения бонуса.

---

## Призыв к написанию плана

Необходимо составить **план доработки** (implementation plan) в виде структурированного документа, в котором:

1. **Раздел «Каталог и скорость»**
   - Где и как кэшировать ответ каталога (ключ, структура, TTL/инвалидация).
   - Порядок рендера: сначала кэш → затем фоновый запрос → обновление.
   - Изменения на бэкенде (если нужны): кэш Floria в Redis, таймауты, ретраи.
   - Обработка ошибок и таймаутов без потери уже закэшированных данных.

2. **Раздел «Профиль и общая стратегия кэша»**
   - Какие данные профиля кэшировать, где хранить, как показывать плашку «Данные актуальны на DD.MM.YYYY, HH:MM».
   - Единый подход к экранам: «сначала кэш, потом фоновое обновление».

3. **Раздел «Бонусы и телефон»**
   - Изменения в UI профиля: убрать постоянное поле телефона из блока «Контакт и бонусы» для сценария приветственного бонуса; оставить одну кнопку «Получить 500 бонусов».
   - Спека поп-апа: поля, валидация, вызов API, закрытие.
   - Размещение телефона под ником Telegram, мелкий шрифт, иконка карандаша, поведение при редактировании.
   - Условие скрытия кнопки навсегда (`welcomeBonusClaimed`).

4. **Порядок внедрения**
   - Что делать в первую очередь (каталог/кэш), что во вторую (профиль/плашка), что в третью (бонусы/поп-ап/телефон под ником).
   - Риски и откат.

5. **Чеклист приёмки**
   - Каталог открывается быстро за счёт кэша; при таймауте не теряются последние данные; есть плашка актуальности.
   - Профиль не показывает «Не удалось загрузить» при наличии кэша; данные обновляются в фоне; плашка отображается.
   - Бонусы: одна кнопка → поп-ап → телефон под ником с карандашом → кнопка исчезает навсегда после получения бонуса.

Используй этот документ как промпт для генерации пошагового плана доработки с конкретными файлами, компонентами и API-вызовами.
