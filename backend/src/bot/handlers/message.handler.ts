import { Context } from 'telegraf';
import { config } from '../../config';
import { handleMenu } from '../commands/menu';
import { db } from '../../database/connection';

export async function handleMessage(ctx: Context): Promise<void> {
  const message = (ctx.message as any)?.text;

  if (!message) {
    return;
  }

  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—ã (–æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ setupCommands)
  // –ö–æ–º–∞–Ω–¥—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ä–∞–Ω—å—à–µ, —á–µ–º —ç—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
  if (message.startsWith('/')) {
    return;
  }

  const user = ctx.from;
  if (!user) return;

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é)
  switch (message) {
    case '–°–¢–ê–†–¢':
    case '–°—Ç–∞—Ä—Ç':
    case '—Å—Ç–∞—Ä—Ç':
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –∫–æ–º–∞–Ω–¥—É /start
      const { handleStart } = await import('../commands/start');
      await handleStart(ctx);
      return;

    case 'üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã':
      await ctx.reply('–§—É–Ω–∫—Ü–∏—è "–ú–æ–∏ –∑–∞–∫–∞–∑—ã" –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Posiflora.');
      break;

    case 'üí∞ –ú–æ–∏ –±–æ–Ω—É—Å—ã':
      await ctx.reply('–§—É–Ω–∫—Ü–∏—è "–ú–æ–∏ –±–æ–Ω—É—Å—ã" –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Posiflora.');
      break;

    case '‚ÑπÔ∏è –û –Ω–∞—Å':
      await ctx.reply(
        '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ.\n\n' +
        '–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –Ω–∞—à —Å–∞–π—Ç –∏–ª–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.'
      );
      break;

    case '‚ùì –ü–æ–º–æ—â—å':
      await ctx.reply(
        '–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, –≤—ã –º–æ–∂–µ—Ç–µ:\n\n' +
        '‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤\n' +
        '‚Ä¢ –ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É\n' +
        '‚Ä¢ –ü–æ–∑–≤–æ–Ω–∏—Ç—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É (–Ω–æ–º–µ—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ)'
      );
      break;

    default:
      // –î–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–æ–≤—ã–π –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      try {
        const userId = user.id.toString();
        const existingUser = await db.query(
          'SELECT id FROM users WHERE telegram_id = $1',
          [userId]
        );

        if (existingUser.rows.length === 0) {
          // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          const firstMessage = 
            `–ß—Ç–æ –º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å —ç—Ç–æ—Ç –±–æ—Ç?\n\n` +
            `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¶–≤–µ—Ç–æ—á–Ω—ã–π ‚Ññ21! üå±\n\n` +
            `–ú—ã –∏–∑–≤–µ—Å—Ç–Ω—ã —Å–≤–æ–µ–π –∑–∞–±–æ—Ç–æ–π –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö –∏ —Ä–æ–∑–∞–º–∏ –ø–æ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏.\n\n` +
            `–£ –Ω–∞—Å –≤—Å—ë —á–µ—Å—Ç–Ω–æ –∏ –∏—Å–∫—Ä–µ–Ω–Ω–µ - –∫—Ä–∞—Å–∏–≤—ã–µ –±—É–∫–µ—Ç—ã –≤ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –∫–æ—Ä–æ–±–∫–µ, —Å –ø–æ–¥–∫–æ—Ä–º–∫–æ–π –∏ –æ—Ç–∫—Ä—ã—Ç–∫–æ–π ‚ù§Ô∏è\n\n` +
            `–û—Ñ–æ—Ä–º–∏ –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ Mini App –≤ –±–æ—Ç–µ ‚Äî –º—ã –¥–æ—Å—Ç–∞–≤–∏–º —Ü–≤–µ—Ç—ã –≤ –ß–µ–±–æ–∫—Å–∞—Ä—ã –∏ –ù–æ–≤–æ—á–µ–±–æ–∫—Å–∞—Ä—Å–∫.\n\n` +
            `–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã, –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞ —Å–≤—è–∑–∏ —Å 8:00 –¥–æ 24:00 üßë‚Äçüíª\n\n` +
            `–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è –Ω–∞ –Ω–∞—à Telegram-–∫–∞–Ω–∞–ª, —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–º —É–∑–Ω–∞–≤–∞—Ç—å –æ –Ω–æ–≤–∏–Ω–∫–∞—Ö –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö: @cvetochniy21\n\n` +
            `–ß—Ç–æ–±—ã –∑–∞–∫–∞–∑–∞—Ç—å –Ω–∞–∂–º–∏ ¬´–°–¢–ê–†–¢¬ª üëá`;

          await ctx.reply(firstMessage, {
            reply_markup: {
              keyboard: [
                [{ text: '/start' }],
              ],
              resize_keyboard: true,
            },
          });

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          await db.query(
            'INSERT INTO users (telegram_id, telegram_username, name, created_at) VALUES ($1, $2, $3, NOW()) ON CONFLICT (telegram_id) DO NOTHING',
            [userId, user.username || null, user.first_name || null]
          );
        } else {
          // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
          await handleMenu(ctx);
        }
      } catch (error) {
        console.error('Error in handleMessage:', error);
        await handleMenu(ctx);
      }
      break;
  }
}
